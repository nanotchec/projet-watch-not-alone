<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>REGARDONS-ENSEMBLE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
</head>

<body class="bg-gray-900 text-white flex flex-col min-h-screen">

    <header class="bg-gray-800 px-6 py-4   flex items-center justify-between border-b border-gray-700">
    <div class="flex items-center space-x-4">
      <img src="https://tailwindcss.com/_next/static/media/tailwind-logo.0cf5a15a.svg" alt="Logo" class="h-8 w-auto" />
      <a href="#" class="flex-1 rounded px-5 py-2 bg-blue-600 hover:bg-blue-700">Accueil</a>
    </div>
    
    <!-- barre de recherche youtube --> 
    <div class="flex items-center space-x-2 w-full md:w-auto">
          <input id="videoUrlInput" type="text" placeholder="Ajouter URL YouTube"
            class="flex-1 px-10 py-2 rounded bg-gray-900 text-white focus:ring-blue-500 focus:ring-2 focus:ring-blue-500" />
          <button id="addVideoBtn"
            class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded whitespace-nowrap">Ajouter</button>
    </div>
    <div class="space-x-4">
      <a href="#" class="rounded font-semibold px-4 py-2 bg-gray-900 hover:bg-gray-700">Connexion</a>
    </div>
  </header>

  <main class="flex flex-1 overflow-hidden">
    <!-- NAVBAR -->
    <aside class="w-40 bg-gray-800 flex flex-col border-r border-gray-700 p-4 space-y-6">
        <button class="w-full bg-blue-700 hover:bg-blue-900 py-2 rounded">Inviter</button>
        <button class="w-full bg-blue-700 hover:bg-blue-900 py-2 rounded">Autorisations</button>
        <button class="w-full bg-blue-700 hover:bg-blue-900 py-2 rounded">Paramètres</button>
        <button class="w-full bg-blue-700 hover:bg-blue-900 py-2 rounded">Aide</button>

        <hr class="border-gray-700" />

        <nav class="flex flex-col space-y-4 text-sm text-gray-400">
            <a href="#" class="hover:underline">A propos</a>
            <a href="#" class="hover:underline">Contact</a>
            <a href="#" class="hover:underline">Mentions légales</a>
        </nav>
    </aside>

    <!-- SALON -->
    <section class="flex flex-col flex-1 bg-gray-900 p-6 overflow-hidden">

      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 space-y-3 md:space-y-0">
        <h1 id="roomName" class="text-2xl font-bold">Nom du salon : nom test</h1>
      </div>

      <!-- LAYOUT BODY -->
      <div class="flex flex-1 space-x-6 overflow-hidden">
        <!-- lecteur + contrôle -->
        <div class="flex flex-col flex-1 bg-black rounded-lg shadow-lg overflow-hidden">
          <!-- Wrapper aspect ratio 16:9: le conteneur fixe la hauteur via padding-top, le player s'étire en position absolue -->
          <div id="playerContainer" class="relative w-full flex-grow pt-[56.25%] bg-black">
            <div id="player" class="absolute inset-0"></div>
          </div>

          <!-- player controls -->
          <div
            class="flex items-center justify-between bg-gray-800 px-4 py-3 border-t border-gray-700 text-white select-none space-x-4">
            <button id="playPauseBtn" aria-label="Lire la vidéo" class="px-4 py-2 bg-indigo-600 rounded hover:bg-indigo-700 flex items-center justify-center">
              <!-- Icônes Heroicons inline (outline) -->
              <svg id="iconPlay" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.92-1.398 1.665-.965l11.54 6.347a1.125 1.125 0 010 1.93l-11.54 6.347a1.125 1.125 0 01-1.665-.965V5.653z" />
              </svg>
              <svg id="iconPause" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor" class="w-6 h-6 hidden">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 5.25h-1.5a.75.75 0 00-.75.75v12a.75.75 0 00.75.75h1.5a.75.75 0 00.75-.75v-12a.75.75 0 00-.75-.75zm6 0h-1.5a.75.75 0 00-.75.75v12a.75.75 0 00.75.75h1.5a.75.75 0 00.75-.75v-12a.75.75 0 00-.75-.75z" />
              </svg>
            </button>

            <input id="seekBar" type="range" min="0" max="100" value="0" class="flex-1 cursor-pointer" />

            <input id="volumeControl" type="range" min="0" max="100" value="50" class="w-24 cursor-pointer" />

            <button id="fullscreenBtn" aria-label="Activer le plein écran" class="px-4 py-2 bg-indigo-600 rounded hover:bg-indigo-700 flex items-center justify-center">
              <!-- Icône expand (aller en plein écran) -->
              <svg id="iconExpand" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75l5.25 5.25m0 0V3.75m0 5.25H3.75M20.25 3.75l-5.25 5.25m0 0V3.75m0 5.25h5.25M3.75 20.25l5.25-5.25m0 0v5.25m0-5.25H3.75M20.25 20.25l-5.25-5.25m0 0v5.25m0-5.25h5.25" />
              </svg>
              <!-- Icône compress (quitter plein écran) -->
              <svg id="iconCompress" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.8" stroke="currentColor" class="w-6 h-6 hidden">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.188 8.812L4.5 4.125M4.5 4.125h4.688M4.5 4.125v4.688M14.813 8.812l4.687-4.687M19.5 4.125h-4.688M19.5 4.125v4.688M9.188 15.188L4.5 19.875M4.5 19.875h4.688M4.5 19.875v-4.688M14.813 15.188l4.687 4.687M19.5 19.875h-4.688M19.5 19.875v-4.688" />
              </svg>
            </button>
          </div>
        </div>

        <!-- carte latérale playlist et chat -->
        <aside class="w-80 flex flex-col space-y-6 overflow-hidden">
          <!-- playlist -->
          <section
            class="bg-gray-800 rounded-lg p-4 flex flex-col max-h-[50vh] overflow-y-auto scrollbar-thin scrollbar-thumb-indigo-600 scrollbar-track-gray-700">
            <h2 class="text-lg font-semibold mb-3">Playlist</h2>
            <ul id="playlist" class="space-y-2">
            </ul>
          </section>

          <!-- chat -->
          <section
            class="bg-gray-800 rounded-lg p-4 flex flex-col max-h-[40vh] overflow-hidden">
            <h2 class="text-lg font-semibold mb-3">Chat</h2>
            <div id="chatMessages" class="flex-1 overflow-y-auto mb-2 space-y-2 bg-gray-900 p-3 rounded scrollbar-thin scrollbar-thumb-blue-600 scrollbar-track-gray-700">
              <!-- messages -->
            </div>
            <form id="chatForm" class="flex space-x-2">
              <input id="chatInput" type="text" placeholder="Écrire un message..."
                class="flex-1 rounded px-3 py-2 bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" />
              <button type="submit" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Envoyer</button>
            </form>
          </section>
        </aside>
      </div>

      <footer
        class="bg-gray-800 border-t border-gray-700 p-4 flex items-center space-x-4 overflow-x-auto scrollbar-thin scrollbar-thumb-blue-600 scrollbar-track-gray-700">
        <h3 class="font-semibold">Participants :</h3>
        <div class="flex space-x-3">
          <img class="w-10 h-10 rounded-full" src="https://i.pravatar.cc/40?img=1" alt="Participant 1" />
          <img class="w-10 h-10 rounded-full" src="https://i.pravatar.cc/40?img=2" alt="Participant 2" />
          <img class="w-10 h-10 rounded-full" src="https://i.pravatar.cc/40?img=3" alt="Participant 3" />
          <img class="w-10 h-10 rounded-full" src="https://i.pravatar.cc/40?img=4" alt="Participant 4" />
        </div>
      </footer>
    </section>
  </main>

  <!-- script youtube & logique -->
  <script>
    let player;
    let playlist = [];
    let currentVideoIndex = 0;

    // Initialisation YouTube API
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '100%',
        width: '100%',
        videoId: '',
        playerVars: {
          autoplay: 0,
          controls: 0, // on fera nos propres contrôles
          modestbranding: 1,
          rel: 0,
        },
        events: {
          onReady: onPlayerReady,
          onStateChange: onPlayerStateChange,
        }
      });
    }

    // quand c'est bon
    function onPlayerReady() {
      updatePlayPauseButton();
      updateVolumeControl();
      updateSeekBar();
      if (playlist.length > 0) {
        loadVideo(0);
      }
    }

    const playPauseBtn = document.getElementById('playPauseBtn');
    playPauseBtn.addEventListener('click', () => {
      if (player.getPlayerState() === YT.PlayerState.PLAYING) {
        player.pauseVideo();
      } else {
        player.playVideo();
      }
    });

    // barre
    const seekBar = document.getElementById('seekBar');
    seekBar.addEventListener('input', () => {
      const duration = player.getDuration();
      const seekTo = duration * (seekBar.value / 100);
      player.seekTo(seekTo, true);
    });

    // volume 
    const volumeControl = document.getElementById('volumeControl');
    volumeControl.addEventListener('input', () => {
      player.setVolume(volumeControl.value);
    });

    // plein écran: toggle + mise à jour des icônes
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    fullscreenBtn.addEventListener('click', () => {
      const iframe = player?.getIframe?.();
      if (!iframe) return;
      if (!document.fullscreenElement) {
        // demander le plein écran
        if (iframe.requestFullscreen) iframe.requestFullscreen();
        else if (iframe.webkitRequestFullscreen) iframe.webkitRequestFullscreen();
        else if (iframe.msRequestFullscreen) iframe.msRequestFullscreen();
      } else {
        // quitter le plein écran
        if (document.exitFullscreen) document.exitFullscreen();
      }
    });

    document.addEventListener('fullscreenchange', () => {
      const expand = document.getElementById('iconExpand');
      const compress = document.getElementById('iconCompress');
      if (!expand || !compress) return;
      if (document.fullscreenElement) {
        expand.classList.add('hidden');
        compress.classList.remove('hidden');
        fullscreenBtn.setAttribute('aria-label', 'Quitter le plein écran');
      } else {
        compress.classList.add('hidden');
        expand.classList.remove('hidden');
        fullscreenBtn.setAttribute('aria-label', 'Activer le plein écran');
      }
    });

    // mise à jour bouton play/pause selon état player
    function updatePlayPauseButton() {
      const state = player.getPlayerState();
      const iconPlay = document.getElementById('iconPlay');
      const iconPause = document.getElementById('iconPause');
      if (!iconPlay || !iconPause) return;
      if (state === YT.PlayerState.PLAYING) {
        iconPlay.classList.add('hidden');
        iconPause.classList.remove('hidden');
        playPauseBtn.setAttribute('aria-label', 'Mettre la vidéo en pause');
      } else {
        iconPause.classList.add('hidden');
        iconPlay.classList.remove('hidden');
        playPauseBtn.setAttribute('aria-label', 'Lire la vidéo');
      }
    }

    // mise à jour barre seek en temps réel
    function updateSeekBar() {
      if (!player || player.getDuration() === 0) {
        seekBar.value = 0;
        return;
      }
      const duration = player.getDuration();
      const currentTime = player.getCurrentTime();
      seekBar.value = (currentTime / duration) * 100;
    }

    // mise à jour volume
    function updateVolumeControl() {
      if (player) {
        volumeControl.value = player.getVolume();
      }
    }

    // quand l'état du player change
    function onPlayerStateChange(event) {
      updatePlayPauseButton();

      // quand la vidéo est terminée, passer à la suivante dans la playlist
      if (event.data === YT.PlayerState.ENDED) {
        playNextVideo();
      }
    }

    // fonction pour charger une vidéo via index dans la playlist
    function loadVideo(index) {
      if (index < 0 || index >= playlist.length) return;
      currentVideoIndex = index;
      // playlist stocke { id, title }
      player.loadVideoById(playlist[index].id);
      highlightPlaylistItem(index);
    }

    // mise a jour de la playlist pour la vidéo en cours
    function highlightPlaylistItem(index) {
      if (!playlistEl) return;
      const items = playlistEl.querySelectorAll('li');
      items.forEach((el, i) => {
        if (i === index) {
          el.classList.add('bg-indigo-600', 'text-white');
        } else {
          el.classList.remove('bg-indigo-600', 'text-white');
        }
      });
    }

    // lancer la video suivante
    function playNextVideo() {
      if (playlist.length === 0) return;
      const next = currentVideoIndex + 1;
      if (next < playlist.length) {
        loadVideo(next);
        if (player && player.playVideo) player.playVideo();
      } else {
        // fin de playlist — on arrête la lecture
        if (player && player.stopVideo) player.stopVideo();
      }
    }

  // fonction pour extraire l'id vidéo youtube
    function extractVideoID(url) {
      const regex = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|embed|shorts)\/|.*[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
      const match = url.match(regex);
      if (match && match[1]) return match[1];
      if (/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;
      return null;
    }
    //ajouter une vidéo à la playlist via bouton
    const addVideoBtn = document.getElementById('addVideoBtn');
    const videoUrlInput = document.getElementById('videoUrlInput');
    const playlistEl = document.getElementById('playlist');

    // récupère le titre d'une vidéo via un player YouTube temporaire
    function fetchTitle(videoID) {
      return new Promise((resolve) => {
        if (!window.YT || !YT.Player) {
          resolve(videoID);
          return;
        }

        const container = document.createElement('div');
        container.style.width = '0px';
        container.style.height = '0px';
        container.style.overflow = 'hidden';
        document.body.appendChild(container);

        const tempPlayer = new YT.Player(container, {
          height: '0',
          width: '0',
          videoId: videoID,
          events: {
            onReady(e) {
              try {
                const info = e.target.getVideoData();
                const title = (info && info.title) ? info.title : videoID;
                resolve(title);
              } catch (err) {
                resolve(videoID);
              } finally {
                setTimeout(() => {
                  try { tempPlayer.destroy(); } catch (e) {}
                  if (container && container.parentNode) container.parentNode.removeChild(container);
                }, 0);
              }
            },
            onError() {
              resolve(videoID);
              try { tempPlayer.destroy(); } catch (e) {}
              if (container && container.parentNode) container.parentNode.removeChild(container);
            }
          }
        });
      });
    }

    addVideoBtn.addEventListener('click', async () => {
      const input = videoUrlInput.value.trim();
      const videoID = extractVideoID(input);
      if (!videoID) {
        alert('Veuillez entrer une URL ou un ID YouTube valide.');
        return;
      }

      // élément provisoire pendant récupération du titre
      const provisionalIndex = playlist.length;
      addVideoToList('Chargement...', provisionalIndex);

      const title = await fetchTitle(videoID);

      // stocker objet {id,title}
      playlist.push({ id: videoID, title });

      // mettre à jour l'élément dans la liste
      const item = playlistEl.querySelectorAll('li')[provisionalIndex];
      if (item) item.textContent = title;

      videoUrlInput.value = '';

      // chargement de la première vidéo
      if (playlist.length === 1 && player && player.loadVideoById) {
        loadVideo(0);
      }
    });

    //ajouter une vidéo dans la liste HTML (titre affiché)
    function addVideoToList(text, index) {
      const li = document.createElement('li');
      li.textContent = text;
      li.className = 'cursor-pointer px-2 py-1 rounded hover:bg-indigo-600';
      li.addEventListener('click', () => loadVideo(index));
      playlistEl.appendChild(li);
    }

    // chat
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const chatMessages = document.getElementById('chatMessages');

    chatForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const msg = chatInput.value.trim();
      if (!msg) return;

      //afficher message dans la chat box
      const p = document.createElement('p');
      p.textContent = `Moi : ${msg}`;
      p.className = 'bg-indigo-600 rounded px-2 py-1 max-w-xs';
      chatMessages.appendChild(p);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      chatInput.value = '';
    });

    //mise à jour continue de la barre seek
    setInterval(() => {
      if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
        updateSeekBar();
      }
    }, 500);

  </script>
</body>

</html>
