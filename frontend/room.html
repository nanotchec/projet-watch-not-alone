<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WatchTogether</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
</head>

<body class="bg-gray-900 text-white flex flex-col min-h-screen">

    <header class="bg-gray-800 px-6 py-4   flex items-center justify-between border-b border-gray-700">
    <div class="flex items-center space-x-4">
      <img src="https://tailwindcss.com/_next/static/media/tailwind-logo.0cf5a15a.svg" alt="Logo" class="h-8 w-auto" />
      <a href="#" class="flex-1 rounded px-5 py-2 bg-blue-600 hover:bg-blue-700">Accueil</a>
    </div>
    
    <!-- barre de recherche youtube --> 
    <div class="flex items-center space-x-2 w-full md:w-auto">
          <input id="videoUrlInput" type="text" placeholder="Ajouter URL YouTube"
            class="flex-1 px-10 py-2 rounded bg-gray-900 text-white focus:ring-blue-500 focus:ring-2 focus:ring-blue-500" />
          <button id="addVideoBtn"
            class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded whitespace-nowrap">Ajouter</button>
    </div>
    <div class="space-x-4">
      <a href="#" class="rounded font-semibold px-4 py-2 bg-gray-900 hover:bg-gray-700">Inscription</a>
      <a href="#" class="rounded font-semibold px-4 py-2 bg-gray-900 hover:bg-gray-700">Connexion</a>
    </div>
  </header>

  <main class="flex flex-1 overflow-hidden">
    <!-- NAVBAR -->
    <aside class="w-40 bg-gray-800 flex flex-col border-r border-gray-700 p-4 space-y-6">
        <button class="w-full bg-blue-700 hover:bg-blue-900 py-2 rounded">Inviter des participants</button>
        <button class="w-full bg-blue-700 hover:bg-blue-900 py-2 rounded">Autorisations</button>
        <button class="w-full bg-blue-700 hover:bg-blue-900 py-2 rounded">Paramètres</button>
        <button class="w-full bg-blue-700 hover:bg-blue-900 py-2 rounded">Aide</button>

        <hr class="border-gray-700" />

        <nav class="flex flex-col space-y-4 text-sm text-gray-400">
            <a href="#" class="hover:underline">A propos</a>
            <a href="#" class="hover:underline">Contact</a>
            <a href="#" class="hover:underline">Mentions légales</a>
        </nav>
    </aside>

    <!-- SALON -->
    <section class="flex flex-col flex-1 bg-gray-900 p-6 overflow-hidden">

      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 space-y-3 md:space-y-0">
        <h1 id="roomName" class="text-2xl font-bold">Nom du salon : nom test</h1>
      </div>

      <!-- LAYOUT BODY -->
      <div class="flex flex-1 space-x-6 overflow-hidden">
        <!-- lecteur + contrôle -->
        <div class="flex flex-col flex-1 bg-black rounded-lg shadow-lg overflow-hidden">
          <div id="player" class="relative flex-grow" style="padding-top: 56.25%; position: relative;"></div>

          <!-- player controls -->
          <div
            class="flex items-center justify-between bg-gray-800 px-4 py-3 border-t border-gray-700 text-white select-none space-x-4">
            <button id="playPauseBtn" class="px-4 py-2 bg-indigo-600 rounded hover:bg-indigo-700">Play</button>

            <input id="seekBar" type="range" min="0" max="100" value="0" class="flex-1 cursor-pointer" />

            <input id="volumeControl" type="range" min="0" max="100" value="50" class="w-24 cursor-pointer" />

            <button id="fullscreenBtn" class="px-4 py-2 bg-indigo-600 rounded hover:bg-indigo-700">Plein écran</button>
          </div>
        </div>

        <!-- carte latérale playlist + chat -->
        <aside class="w-80 flex flex-col space-y-6 overflow-hidden">
          <!-- Playlist -->
          <section
            class="bg-gray-800 rounded-lg p-4 flex flex-col max-h-[50vh] overflow-y-auto scrollbar-thin scrollbar-thumb-indigo-600 scrollbar-track-gray-700">
            <h2 class="text-lg font-semibold mb-3">Playlist</h2>
            <ul id="playlist" class="space-y-2">
              <!-- vidéos ajoutées dynamiquement ici -->
            </ul>
          </section>

          <!-- chat -->
          <section
            class="bg-gray-800 rounded-lg p-4 flex flex-col max-h-[40vh] overflow-hidden">
            <h2 class="text-lg font-semibold mb-3">Chat</h2>
            <div id="chatMessages" class="flex-1 overflow-y-auto mb-2 space-y-2 bg-gray-900 p-3 rounded scrollbar-thin scrollbar-thumb-blue-600 scrollbar-track-gray-700">
              <!-- messages -->
            </div>
            <form id="chatForm" class="flex space-x-2">
              <input id="chatInput" type="text" placeholder="Écrire un message..."
                class="flex-1 rounded px-3 py-2 bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" />
              <button type="submit" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Envoyer</button>
            </form>
          </section>
        </aside>
      </div>

      <footer
        class="bg-gray-800 border-t border-gray-700 p-4 flex items-center space-x-4 overflow-x-auto scrollbar-thin scrollbar-thumb-blue-600 scrollbar-track-gray-700">
        <h3 class="font-semibold">Participants :</h3>
        <div class="flex space-x-3">
          <img class="w-10 h-10 rounded-full" src="https://i.pravatar.cc/40?img=1" alt="Participant 1" />
          <img class="w-10 h-10 rounded-full" src="https://i.pravatar.cc/40?img=2" alt="Participant 2" />
          <img class="w-10 h-10 rounded-full" src="https://i.pravatar.cc/40?img=3" alt="Participant 3" />
          <img class="w-10 h-10 rounded-full" src="https://i.pravatar.cc/40?img=4" alt="Participant 4" />
        </div>
      </footer>
    </section>
  </main>

  <!-- script youtube & logique -->
  <script>
    let player;
    let playlist = [];
    let currentVideoIndex = 0;

    // Initialisation YouTube API
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '100%',
        width: '100%',
        videoId: '',
        playerVars: {
          autoplay: 0,
          controls: 0, // on fera nos propres contrôles
          modestbranding: 1,
          rel: 0,
        },
        events: {
          onReady: onPlayerReady,
          onStateChange: onPlayerStateChange,
        }
      });
    }

    // Quand player prêt
    function onPlayerReady() {
      updatePlayPauseButton();
      updateVolumeControl();
      updateSeekBar();
      // Charger la première vidéo si la playlist n'est pas vide
      if (playlist.length > 0) {
        loadVideo(0);
      }
    }

    const playPauseBtn = document.getElementById('playPauseBtn');
    playPauseBtn.addEventListener('click', () => {
      if (player.getPlayerState() === YT.PlayerState.PLAYING) {
        player.pauseVideo();
      } else {
        player.playVideo();
      }
    });

    // barre
    const seekBar = document.getElementById('seekBar');
    seekBar.addEventListener('input', () => {
      const duration = player.getDuration();
      const seekTo = duration * (seekBar.value / 100);
      player.seekTo(seekTo, true);
    });

    // volume 
    const volumeControl = document.getElementById('volumeControl');
    volumeControl.addEventListener('input', () => {
      player.setVolume(volumeControl.value);
    });

    // video en plein écran
    document.getElementById('fullscreenBtn').addEventListener('click', () => {
      const elem = player.getIframe();
      if (elem.requestFullscreen) {
        elem.requestFullscreen();
      } else if (elem.webkitRequestFullscreen) { /* Safari */
        elem.webkitRequestFullscreen();
      } else if (elem.msRequestFullscreen) { /* IE11 */
        elem.msRequestFullscreen();
      }
    });

    // mise à jour bouton play/pause selon état player
    function updatePlayPauseButton() {
      const state = player.getPlayerState();
      if (state === YT.PlayerState.PLAYING) {
        playPauseBtn.textContent = 'Pause';
      } else {
        playPauseBtn.textContent = 'Play';
      }
    }

    // mise à jour barre seek en temps réel
    function updateSeekBar() {
      if (!player || player.getDuration() === 0) {
        seekBar.value = 0;
        return;
      }
      const duration = player.getDuration();
      const currentTime = player.getCurrentTime();
      seekBar.value = (currentTime / duration) * 100;
    }

    // mise à jour volume (initiale)
    function updateVolumeControl() {
      if (player) {
        volumeControl.value = player.getVolume();
      }
    }

    // quand l'état du player change
    function onPlayerStateChange(event) {
      updatePlayPauseButton();

      // quand la vidéo est terminée, passer à la suivante dans la playlist
      if (event.data === YT.PlayerState.ENDED) {
        playNextVideo();
      }
    }

    // fonction pour charger une vidéo via index dans la playlist
    function loadVideo(index) {
      if (index < 0 || index >= playlist.length) return;
      currentVideoIndex = index;
      player.loadVideoById(playlist[index]);
      highlightPlaylistItem(index);
    }

    }

    // fonction pour extraire ID vidéo YouTube d'une URL ou ID brute
    function extractVideoID(url) {
      const regex = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|embed|shorts)\/|.*[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
      const match = url.match(regex);
      if (match && match[1]) return match[1];
      if (/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;
      return null;
    }

    //ajouter une vidéo à la playlist via bouton
    const addVideoBtn = document.getElementById('addVideoBtn');
    const videoUrlInput = document.getElementById('videoUrlInput');
    const playlistEl = document.getElementById('playlist');

    addVideoBtn.addEventListener('click', () => {
      const input = videoUrlInput.value.trim();
      const videoID = extractVideoID(input);
      if (!videoID) {
        alert('Veuillez entrer une URL ou un ID YouTube valide.');
        return;
      }
      playlist.push(videoID);
      addVideoToList(videoID, playlist.length - 1);
      videoUrlInput.value = '';

      //  cchargement premiere video
      if (playlist.length === 1 && player && player.loadVideoById) {
        loadVideo(0);
      }
    });

    //ajouter une vidéo dans la liste HTML
    function addVideoToList(videoID, index) {
      const li = document.createElement('li');
      li.textContent = videoID;
      li.className = 'cursor-pointer px-2 py-1 rounded hover:bg-indigo-600';
      li.addEventListener('click', () => loadVideo(index));
      playlistEl.appendChild(li);
    }

    // chat
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const chatMessages = document.getElementById('chatMessages');

    chatForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const msg = chatInput.value.trim();
      if (!msg) return;

      //afficher message dans la chat box
      const p = document.createElement('p');
      p.textContent = `Moi : ${msg}`;
      p.className = 'bg-indigo-600 rounded px-2 py-1 max-w-xs';
      chatMessages.appendChild(p);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      chatInput.value = '';
    });

    //mise à jour continue de la barre seek
    setInterval(() => {
      if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
        updateSeekBar();
      }
    }, 500);

  </script>
</body>

</html>
